# Spatialâ€‘Riskâ€‘TDA

*A Topological Data Analysis (TDA) workflow for measuring unâ€‘measured spatial risk and fitting Besagâ€“Yorkâ€“MolliÃ© (BYMâ€‘T) models to opioidâ€‘related health outcomes.*

This repository contains the full research pipelineâ€”from raw countyâ€‘level data to Bayesian spatial modelsâ€”used in our study of opioid vulnerability across U.S. counties. The core stages are:

1. **Data preâ€‘processing** â€“ Clean Social Vulnerability Index (SVI) shapefiles, overdose mortality counts, and census populations.
2. **TDA summary generation** â€“ Build adjacencyâ€‘based simplicial complexes and extract persistence summaries that capture latent spatial structure.
3. **Bayesian modeling** â€“ Reâ€‘parameterise the BYM model to include the TDA effect (BYMâ€‘T) and fit it in selected states.

---

## ğŸ“ Repository layout

```text
SPATIAL-RISK-TDA/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ raw_data/                # ğŸ”’ original SVI & overdose data (not tracked)
â”‚   â””â”€â”€ processed_data/          # ğŸ“ˆ cleaned & merged data ready for analysis
â”‚
â”œâ”€â”€ data_processing/
â”‚   â”œâ”€â”€ main_data_process.ipynb  # endâ€‘toâ€‘end notebook: raw â†’ processed
â”‚   â”œâ”€â”€ svi_treat_null.py        # helper script to impute / treat SVI nulls
â”‚   â”œâ”€â”€ smr.py                   # utilities for Standard Mortality Ratio (SMR)
â”‚   â””â”€â”€ __pycache__/             # autoâ€‘generated bytecode
â”‚
â”œâ”€â”€ simulations/                 # synthetic experiments
â”‚   â”œâ”€â”€ controlled_ac.ipynb      # vary autocorrelation strength
â”‚   â”œâ”€â”€ controlled_avg.ipynb     # vary mean risk level
â”‚   â””â”€â”€ controlled_grid.ipynb    # vary spatial grid patterns
â”‚
â”œâ”€â”€ results/                     # model outputs, figures & tables
â”‚
â”œâ”€â”€ utills/                      # general utility modules (I/O, viz, etc.)
â”‚
â”œâ”€â”€ generate_tda_summaries.ipynb # compute persistence diagrams & images
â”œâ”€â”€ bym_modeling_tn.ipynb        # BYMâ€‘T case study â€“ Tennessee
â”œâ”€â”€ bym_modeling_va.ipynb        # BYMâ€‘T case study â€“ Virginia
â”‚
â”œâ”€â”€ requirements.txt             # reproducible Python environment
â”œâ”€â”€ .gitignore                   # ignore large / sensitive files
â””â”€â”€ README.md                    # you are here
```

> **Note**: Raw data live in `data/raw_data/` and are *not* under version control. Add them manually following the instructions below.

---

## ğŸš€ Quickâ€‘start

### 1. Clone & create environment

```bash
git clone https://github.com/<yourâ€‘org>/spatial-risk-tda.git
cd spatial-risk-tda
conda create -n spatial-tda python=3.11
conda activate spatial-tda
pip install -r requirements.txt
```

### 2. Supply raw inputs

Place the following files in **`data/raw_data/`**:

| Dataset                                    | Source | Example filename          |
| ------------------------------------------ | ------ | ------------------------- |
| CDC WONDER overdose mortality counts       | CDC    | `overdose_2014_2020.csv`  |
| Social Vulnerability Index (SVI) shapefile | ATSDR  | `SVI_2018_US.shp`         |
| ACS countyâ€‘level population estimates      | Census | `acs_2019_population.csv` |

### 3. Run the preâ€‘processing pipeline

Open **`data_processing/main_data_process.ipynb`** and execute all cells.

Alternatively, run the key scripts directly:

```bash
python data_processing/svi_treat_null.py   # clean & impute SVI
python data_processing/smr.py              # calculate countyâ€‘level SMR
```

Cleaned outputs will be written to **`data/processed_data/`**.

### 4. Generate TDA summaries

```bash
jupyter nbconvert --execute generate_tda_summaries.ipynb
```

This notebook constructs adjacencyâ€‘based simplicial complexes for each countyâ€‘level snapshot and stores persistence diagrams / images needed for downstream modeling.

### 5. Fit BYMâ€‘T models

Select a stateâ€‘specific notebook (e.g. **`bym_modeling_tn.ipynb`**) and run the full workflow to:

1. Load processed data and TDA summaries.
2. Compose the BYMâ€‘T hierarchical model in PyMC.
3. Sample with NUTS, diagnose convergence, and save posterior draws.
4. Produce comparative WAIC/LOO metrics and visualise relative risk maps.

Outputs (trace files, figures) are saved under **`results/`**.

### 6. (Optional) Synthetic simulations

Use notebooks in **`simulations/`** to evaluate how well TDA summaries capture known spatial structures under controlled settings.

---

## ğŸ”„ Reproducibility tips

* `requirements.txt` pins all critical dependencies; consider `pip install -r requirements.txt --no-binary :all:` for deterministic builds.
* Set the `PYTHONHASHSEED` environment variable for exact hashâ€‘based splits.
* For GPU sampling (CUDAâ€‘enabled PyMC), ensure a compatible NVIDIA driver and CUDA runtime are present.

---

## ğŸ“œ Citation

If you use this code, please cite:

<!-- ```bibtex
@article{your2025tda,
  title   = {},
  author  = {},
  journal = {},
  year    = {}
}
``` -->

---

## ğŸ“ License

MIT â€“ see `LICENSE` for details.

---

*Happy modeling!*
